<!DOCTYPE html>
<html lang="my">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>VPS Script Runner - Groups + New Host + Quick Run</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.css" />
  <style>
    :root{--primary:#00d4aa;--secondary:#00997a;--success:#00d4aa;--danger:#ff6b6b;--warning:#ffd93d;--dark:#1a1b26;--darker:#16161e;--terminal-bg:#1a1b26;}
    *{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif}
    body{background:var(--darker);color:#fff;min-height:100vh;}
    .container{display:grid;grid-template-columns:360px 1fr;height:100vh;overflow:hidden}
    .sidebar{background:var(--dark);border-right:1px solid #2a2b3a;padding:14px;overflow-y:auto;position:relative}
    .main-content{display:flex;flex-direction:column;background:var(--darker)}
    header{padding:12px 16px;background:var(--dark);border-bottom:1px solid #2a2b3a;display:flex;justify-content:space-between;align-items:center;gap:8px}
    h1{font-size:1.15rem;background:linear-gradient(90deg,var(--primary),var(--success));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .logo{display:flex;align-items:center;gap:10px}.logo-icon{width:32px;height:32px;background:var(--primary);border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#0d0f14}
    .card{background:rgba(255,255,255,.05);border-radius:12px;padding:14px;margin-bottom:12px;border:1px solid rgba(255,255,255,.1)}
    .card h2{margin-bottom:10px;color:var(--primary);font-size:1rem;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .form-grid-1{display:grid;grid-template-columns:1fr;gap:10px}
    .form-group{display:flex;flex-direction:column;gap:6px}
    label{font-size:.85rem;color:#a9b1d6}
    input,select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #2a2b3a;background:rgba(0,0,0,.3);color:#fff;font-size:.9rem}
    input:focus,select:focus{outline:none;border-color:var(--primary)}
    .btn{padding:10px 14px;background:var(--primary);color:#1a1b26;border:none;border-radius:8px;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;justify-content:center;gap:6px}
    .btn:hover{transform:translateY(-1px)}.btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-success{background:var(--success)}.btn-danger{background:var(--danger);color:#fff}.btn-warning{background:var(--warning);color:#1a1b26}
    .btn-secondary{background:#2b2f3f;color:#e5e7f3}.btn-sm{padding:7px 10px;font-size:.8rem}.btn-full{width:100%}
    .quick-actions{display:flex;gap:8px}
    .action-btn{flex:1;padding:9px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#fff;text-align:center;font-size:.9rem;cursor:pointer}
    .action-btn:hover{background:rgba(0,212,170,.2);border-color:var(--primary)}
    .backend-status{background:rgba(0,0,0,.3);padding:8px 12px;border-radius:8px;margin-bottom:12px;border-left:3px solid var(--success);font-size:.9rem}
    .backend-status.offline{border-left-color:var(--danger)}
    .terminal-container{flex:1;padding:14px;background:var(--terminal-bg)}
    #terminal{height:100%;border-radius:10px;overflow:hidden}
    .status-bar{display:flex;justify-content:space-between;padding:10px 14px;background:var(--dark);border-top:1px solid #2a2b3a;font-size:.85rem;color:#a9b1d6;gap:10px;flex-wrap:wrap}
    .connection-status{display:inline-flex;align-items:center;gap:8px}
    .status-indicator{width:8px;height:8px;border-radius:50%;background:var(--danger)}.status-connected{background:var(--success)}
    .script-buttons{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
    .script-btn{padding:12px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.08);border-radius:10px;color:#fff;cursor:pointer;text-align:left;display:flex;flex-direction:column;gap:6px}
    .script-btn:hover{background:rgba(0,212,170,.15);border-color:var(--primary)}
    .script-btn.active{background:rgba(0,212,170,.25);border-color:var(--primary);box-shadow:0 0 12px rgba(0,212,170,.2)}
    .script-name{font-weight:800;font-size:1rem;color:var(--primary)}.script-desc{font-size:.85rem;color:#a9b1d6}
    .run-script-btn{margin-top:10px;padding:12px;font-size:1rem;font-weight:800}
    /* Groups */
    .group{margin-bottom:10px}
    .group-header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.08);border-radius:8px;cursor:pointer}
    .group-title{font-weight:700;color:#e6fff8}
    .group-actions{display:inline-flex;gap:6px}
    .group-body{margin-top:8px;display:none}.group.open .group-body{display:block}
    .server-item{padding:10px;background:rgba(0,0,0,.25);border-radius:8px;margin-bottom:8px;border-left:3px solid var(--primary)}
    .server-row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .server-name{font-weight:700;margin-bottom:4px}.server-details{font-size:.85rem;color:#a9b1d6}
    .server-actions{display:flex;flex-wrap:wrap;gap:6px}
    .row-split{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .notification{position:fixed;top:16px;right:16px;padding:12px 16px;background:var(--success);color:#0d0f14;border-radius:10px;font-weight:800;z-index:1000;transform:translateX(150%);transition:transform .25s ease}
    .notification.show{transform:translateX(0)}.notification.error{background:var(--danger);color:#fff}
    /* Moved Tabs (under Saved Servers) */
    .tab-card .tab-bar{display:flex;gap:6px;flex-wrap:wrap}
    .tab-card .tab{padding:8px 12px;background:#22263a;border:1px solid rgba(255,255,255,.08);color:#a9b1d6;border-radius:8px;cursor:pointer}
    .tab-card .tab.active{background:#1f2a2a;border-color:var(--primary);color:var(--primary)}
    /* FAB */
    .fab{position:sticky;bottom:12px;left:100%;transform:translateX(-80px);width:52px;height:52px;border-radius:16px;background:#9fb9ff1a;border:1px solid rgba(255,255,255,.1);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center}
    .fab .btn{width:44px;height:44px;border-radius:14px;background:#a7c4ff;color:#10213a;font-weight:900}
    /* Mobile */
    .mobile-toggle{display:none;padding:8px 10px}
    @media (max-width:980px){
      .container{grid-template-columns:1fr}
      .sidebar{position:fixed;z-index:999;top:0;left:0;height:100vh;width:88%;max-width:380px;transform:translateX(-102%);box-shadow:8px 0 24px rgba(0,0,0,.4);transition:transform .25s ease}
      .sidebar.open{transform:translateX(0)}.mobile-toggle{display:inline-flex}
      body.sidebar-open{overflow:hidden}
    }
    @media (max-width:520px){
      .form-grid{grid-template-columns:1fr}.row-split{grid-template-columns:1fr}
      .quick-actions{flex-direction:column}
    }
    .script-preview{display:none}
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="logo" style="margin-bottom:12px;">
        <div class="logo-icon">VPS</div><h1>Script Runner</h1>
      </div>

      <div class="backend-status" id="backendStatus">üîó Backend: Connecting to script.jvpnapp.site...</div>

      <!-- VPS Connection -->
      <div class="card">
        <h2>VPS Connection</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="serverName">VPS Name</label>
            <input type="text" id="serverName" placeholder="My VPS Server">
          </div>
          <div class="form-group">
            <label for="groupSelect">Group</label>
            <div class="row-split">
              <select id="groupSelect"></select>
              <button id="addGroupBtn" class="btn btn-secondary">+ Group</button>
            </div>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="vpsIp">VPS IP Address</label>
            <input type="text" id="vpsIp" placeholder="103.117.149.104">
          </div>
          <div class="form-group">
            <label for="vpsPort">Port</label>
            <input type="number" id="vpsPort" value="22">
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="vpsUser">Username</label>
            <input type="text" id="vpsUser" placeholder="root">
          </div>
          <div class="form-group">
            <label for="vpsPass">Password</label>
            <input type="password" id="vpsPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
        </div>

        <div class="row-split" style="margin-top:8px;">
          <button id="saveServerBtn" class="btn">üíæ Save</button>
          <button id="resetFormBtn" class="btn btn-secondary">‚Ü∫ Reset</button>
        </div>

        <div class="row-split" style="margin-top:8px;">
          <button id="connectBtn" class="btn btn-success">üîå Connect</button>
          <button id="disconnectBtn" class="btn btn-danger" disabled>‚èè Disconnect</button>
        </div>

        <div class="connection-status" style="margin-top: 12px;">
          <div class="status-indicator"></div>
          <span id="connectionStatusText">Not connected</span>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <h2>Quick Actions</h2>
        <div class="quick-actions">
          <button class="action-btn" id="sudoSuBtn">sudo su</button>
          <button class="action-btn" id="clearBtn">Clear</button>
          <button class="action-btn" id="updateBtn">apt update</button>
        </div>
      </div>

      <!-- Scripts -->
      <div class="card">
        <h2>Scripts</h2>
        <div class="script-buttons">
          <div class="script-btn" data-script="sshplus"><div class="script-name">SSHPLUS</div><div class="script-desc">SSH Management Script</div></div>
          <div class="script-btn" data-script="agnudp"><div class="script-name">AGNUDP</div><div class="script-desc">UDP Custom Script</div></div>
          <div class="script-btn" data-script="zivpn"><div class="script-name">ZIVPN</div><div class="script-desc">VPN Installation</div></div>
          <div class="script-btn" data-script="v2ray"><div class="script-name">V2RAY</div><div class="script-desc">V2Ray Installation</div></div>
        </div>
        <button id="runScriptBtn" class="btn btn-success btn-full run-script-btn" disabled>üöÄ Run Selected Script</button>
      </div>

      <!-- Saved Servers (Groups) -->
      <div class="card">
        <h2>
          Saved Servers
          <button id="newHostGlobalBtn" class="btn btn-secondary btn-sm">+ New Host</button>
        </h2>
        <div class="form-grid-1" style="margin-bottom:8px;">
          <div class="row-split">
            <button id="expandAllBtn" class="btn btn-secondary btn-sm">‚ñæ Expand All</button>
            <button id="collapseAllBtn" class="btn btn-secondary btn-sm">‚ñ∏ Collapse All</button>
          </div>
        </div>
        <div class="server-list" id="serverList">
          <p style="text-align:center;color:#a9b1d6;font-size:.9rem;">No servers saved</p>
        </div>
      </div>

      <!-- Tabs under Saved Servers -->
      <div class="card tab-card">
        <h2>Views</h2>
        <div class="tab-bar" id="sideTabs">
          <button class="tab active" data-tab="terminal">Terminal</button>
          <button class="tab" data-tab="output">Script Output</button>
          <button class="tab" data-tab="settings">Settings</button>
        </div>
      </div>

      <!-- Floating Add -->
      <div class="fab"><button id="fabAdd" class="btn">+</button></div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <header>
        <div style="display:flex;align-items:center;gap:8px;">
          <button id="sidebarToggle" class="btn btn-secondary btn-sm mobile-toggle">‚ò∞</button>
          <span id="currentServer">No server connected</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="btn btn-sm btn-warning" id="newTabBtn">+ New Tab</button>
        </div>
      </header>

      <div class="terminal-container">
        <div id="terminal"></div>
      </div>

      <div class="status-bar">
        <div class="connection-status">
          <div class="status-indicator"></div>
          <span id="sshStatus">SSH: Not connected</span>
        </div>
        <div>
          <span id="terminalStatus">Ready - Select a script and click Run</span>
        </div>
      </div>
    </div>
  </div>

  <div id="notification" class="notification"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/addons/fit/fit.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    class VPSScriptRunner{
      constructor(){
        this.term=null;this.socket=null;this.isConnected=false;this.connectionId=null;this.currentServer=null;
        this.saved=this.loadInitialStorage();
        this.commandHistory=[];this.historyIndex=-1;this.currentLine='';
        this.backendUrl='https://script.jvpnapp.site';
        this.selectedScript=null;this.isEditing=false;this.editingIds={groupId:null,serverId:null};

        this.scripts={
          sshplus:{name:"SSHPLUS",description:"SSH Management Script",command:"apt update -y && apt upgrade -y && wget https://raw.githubusercontent.com/JVPNSHOP/JK-SCRIPTS/refs/heads/main/Plus && chmod 777 Plus && ./Plus"},
          agnudp:{name:"AGNUDP",description:"UDP Custom Script",command:"apt-get remove command-not-found -y && wget https://raw.githubusercontent.com/Juessh/Juevpnscript/main/install_jueudp.sh && chmod +x install_jueudp.sh; ./install_jueudp.sh"},
          zivpn:{name:"ZIVPN",description:"VPN Installation",command:"wget -O zi.sh https://raw.githubusercontent.com/JVPNSHOP/Paid-Zivpn-Script/main/zi.sh && sudo chmod +x zi.sh && sudo ./zi.sh"},
          v2ray:{name:"V2RAY",description:"V2Ray Installation",command:"bash <(curl -Ls https://raw.githubusercontent.com/mhsanaei/3x-ui/master/install.sh)"}
        };

        this.initializeTerminal();
        this.initializeSocket();
        this.initializeEventListeners();
        this.renderGroups();
        this.refreshGroupSelect();
        this.checkBackendStatus();
      }

      // ===== Storage with migration =====
      loadInitialStorage(){
        const groupsStr=localStorage.getItem('savedGroupsV2');
        const oldServers=JSON.parse(localStorage.getItem('savedServers')||'[]');
        if(groupsStr){ try{return JSON.parse(groupsStr);}catch{} }
        const ungrouped={groups:[{id:this.uid(),name:'Ungrouped',open:true,servers:(oldServers||[]).map(s=>({
          id:s.id||this.uid(),name:s.name||'Unnamed Server',ip:s.ip||'',port:String(s.port||'22'),user:s.user||'',pass:s.pass||'',date:s.date||new Date().toLocaleString()
        }))}]};
        localStorage.setItem('savedGroupsV2',JSON.stringify(ungrouped));
        return ungrouped;
      }
      persist(){localStorage.setItem('savedGroupsV2',JSON.stringify(this.saved));}
      uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36);}

      // ===== Render groups & servers =====
      renderGroups(){
        const list=document.getElementById('serverList');
        if(!this.saved.groups.length){list.innerHTML='<p style="text-align:center;color:#a9b1d6;font-size:.9rem;">No servers saved</p>';return;}
        list.innerHTML='';
        this.saved.groups.forEach(group=>{
          const wrap=document.createElement('div');wrap.className=`group ${group.open?'open':''}`;
          const header=document.createElement('div');header.className='group-header';
          header.innerHTML=`
            <span class="group-title">üìÅ ${group.name} <span style="opacity:.6;font-weight:500;">(${group.servers.length})</span></span>
            <span class="group-actions">
              <button class="btn btn-secondary btn-sm" data-act="add-host">+ New Host</button>
              <button class="btn btn-secondary btn-sm" data-act="rename">Rename</button>
              <button class="btn btn-danger btn-sm" data-act="delete-group">Delete</button>
              <button class="btn btn-secondary btn-sm" data-act="toggle">${group.open?'‚ñæ':'‚ñ∏'}</button>
            </span>`;
          header.querySelector('[data-act="toggle"]').addEventListener('click',e=>{e.stopPropagation();group.open=!group.open;this.persist();this.renderGroups();});
          header.querySelector('[data-act="rename"]').addEventListener('click',e=>{
            e.stopPropagation();const nm=prompt('Rename group',group.name);
            if(nm&&nm.trim()){group.name=nm.trim();this.persist();this.renderGroups();this.refreshGroupSelect();this.showNotification('Group renamed','success');}
          });
          header.querySelector('[data-act="delete-group"]').addEventListener('click',e=>{
            e.stopPropagation();if(!confirm('Delete this group and all servers inside?'))return;
            this.saved.groups=this.saved.groups.filter(g=>g.id!==group.id);this.persist();this.renderGroups();this.refreshGroupSelect();this.showNotification('Group deleted','success');
          });
          header.querySelector('[data-act="add-host"]').addEventListener('click',e=>{
            e.stopPropagation();
            document.getElementById('groupSelect').value=group.id;
            document.getElementById('serverName').focus();
            this.showNotification(`New Host in "${group.name}"`,'success');
          });
          header.addEventListener('click',()=>{group.open=!group.open;this.persist();this.renderGroups();});

          const body=document.createElement('div');body.className='group-body';
          if(!group.servers.length){
            body.innerHTML='<p style="color:#a9b1d6;font-size:.9rem;">No servers in this group</p>';
          }else{
            group.servers.forEach(server=>{
              const item=document.createElement('div');item.className='server-item';
              item.innerHTML=`
                <div class="server-row">
                  <div>
                    <div class="server-name">${server.name}</div>
                    <div class="server-details">${server.ip}:${server.port} (${server.user||'user'})</div>
                  </div>
                  <div class="server-actions">
                    <button class="btn btn-secondary btn-sm" data-act="load">Load</button>
                    <button class="btn btn-success btn-sm" data-act="connect">Connect</button>
                    <button class="btn btn-warning btn-sm" data-act="run">Run</button>
                    <button class="btn btn-secondary btn-sm" data-act="edit">Edit</button>
                    <button class="btn btn-danger btn-sm" data-act="delete">Delete</button>
                  </div>
                </div>`;
              // Actions
              item.querySelector('[data-act="load"]').addEventListener('click',()=>this.loadServer(server,group.id));
              item.querySelector('[data-act="connect"]').addEventListener('click',()=>this.quickConnect(server));
              item.querySelector('[data-act="run"]').addEventListener('click',()=>this.quickRun(server));
              item.querySelector('[data-act="edit"]').addEventListener('click',()=>{
                this.loadServer(server,group.id);this.isEditing=true;this.editingIds={groupId:group.id,serverId:server.id};
                this.showNotification('Edit mode: make changes then Save','success');
              });
              item.querySelector('[data-act="delete"]').addEventListener('click',()=>{
                if(!confirm(`Delete server "${server.name}"?`))return;
                const g=this.saved.groups.find(g=>g.id===group.id);if(!g)return;
                g.servers=g.servers.filter(s=>s.id!==server.id);this.persist();this.renderGroups();this.showNotification('Server deleted','success');
              });
              body.appendChild(item);
            });
          }
          wrap.appendChild(header);wrap.appendChild(body);list.appendChild(wrap);
        });

        document.getElementById('expandAllBtn')?.addEventListener('click',()=>{this.saved.groups.forEach(g=>g.open=true);this.persist();this.renderGroups();});
        document.getElementById('collapseAllBtn')?.addEventListener('click',()=>{this.saved.groups.forEach(g=>g.open=false);this.persist();this.renderGroups();});
      }

      refreshGroupSelect(){
        const sel=document.getElementById('groupSelect');sel.innerHTML='';
        this.saved.groups.forEach(g=>{const opt=document.createElement('option');opt.value=g.id;opt.textContent=g.name;sel.appendChild(opt);});
        if(this.saved.groups.length===0){
          const g={id:this.uid(),name:'Ungrouped',open:true,servers:[]};this.saved.groups.push(g);this.persist();this.refreshGroupSelect();
        }
      }

      // ===== Terminal =====
      initializeTerminal(){
        this.term=new Terminal({
          theme:{background:'#1a1b26',foreground:'#c0caf5',cursor:'#c0caf5',selection:'#33467c',black:'#15161e',red:'#f7768e',green:'#9ece6a',yellow:'#e0af68',blue:'#7aa2f7',magenta:'#bb9af7',cyan:'#7dcfff',white:'#a9b1d6'},
          fontSize:14,fontFamily:'Consolas, "Courier New", monospace',cursorBlink:true
        });
        this.term.open(document.getElementById('terminal'));
        setTimeout(()=>{if(this.term.fit){this.term.fit();}},120);
        this.writeToTerminal('üöÄ VPS Script Runner - All Scripts Integrated\r\n');
        this.writeToTerminal('üì° Backend: script.jvpnapp.site\r\n');
        this.writeToTerminal('üí° Connect to VPS and select any script to run\r\n\r\n');
        this.writeToTerminal('Available Scripts:\r\n‚Ä¢ SSHPLUS - SSH Management\r\n‚Ä¢ AGNUDP - UDP Custom\r\n‚Ä¢ ZIVPN - VPN Installation\r\n‚Ä¢ V2RAY - V2Ray Panel\r\n\r\n');
        this.writePrompt();
        this.term.onData(d=>this.handleTerminalInput(d));
        window.addEventListener('resize',()=>{if(this.term.fit){this.term.fit();}});
      }

      initializeSocket(){
        try{
          this.socket=io(this.backendUrl,{timeout:5000,reconnectionAttempts:3,transports:['websocket','polling']});
          this.socket.on('connect',()=>{this.updateBackendStatus('‚úÖ Backend: Connected',true);this.showNotification('Connected to backend server','success');});
          this.socket.on('disconnect',()=>{this.updateBackendStatus('‚ùå Backend: Disconnected',false);this.showNotification('Disconnected from backend','error');});
          this.socket.on('connect_error',e=>{this.updateBackendStatus('‚ùå Backend: Connection Failed',false);this.showNotification('Backend connection failed: '+e.message,'error');});
          this.socket.on('command-output',d=>this.writeToTerminal(d.data));
          this.socket.on('command-complete',()=>this.writePrompt());
          this.socket.on('script-output',d=>this.writeToTerminal(d.data));
          this.socket.on('script-complete',d=>{this.writeToTerminal(`\r\nüéâ Script execution completed with exit code: ${d.code}\r\n`);this.writePrompt();this.showNotification('Script execution completed!','success');});
          this.socket.on('script-error',d=>{this.writeToTerminal(`\r\n‚ùå Script error: ${d.error}\r\n`);this.writePrompt();this.showNotification('Script execution failed!','error');});
          this.socket.on('script-start',d=>{this.writeToTerminal(`\r\nüöÄ Starting ${d.script.toUpperCase()} script...\r\nüìù Command: ${d.command}\r\n\r\n`);});
        }catch(e){console.error('Socket init error',e);this.updateBackendStatus('‚ùå Backend: Initialization Failed',false);}
      }

      initializeEventListeners(){
        // Mobile sidebar
        const sidebar=document.getElementById('sidebar');const toggle=document.getElementById('sidebarToggle');
        toggle?.addEventListener('click',()=>{sidebar.classList.toggle('open');document.body.classList.toggle('sidebar-open',sidebar.classList.contains('open'));});
        document.addEventListener('click',(e)=>{const inside=sidebar.contains(e.target)||(toggle&&toggle.contains(e.target));if(window.matchMedia('(max-width:980px)').matches&&!inside&&sidebar.classList.contains('open')){sidebar.classList.remove('open');document.body.classList.remove('sidebar-open');}});

        // Tabs (cosmetic)
        document.querySelectorAll('#sideTabs .tab').forEach(btn=>{
          btn.addEventListener('click',()=>{
            document.querySelectorAll('#sideTabs .tab').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            this.showNotification(`Switched to: ${btn.dataset.tab}`,'success');
          });
        });

        // Group add
        document.getElementById('addGroupBtn').addEventListener('click',()=>{
          const name=prompt('New group name');if(!name||!name.trim())return;
          this.saved.groups.push({id:this.uid(),name:name.trim(),open:true,servers:[]});this.persist();this.renderGroups();this.refreshGroupSelect();this.showNotification('Group added','success');
        });

        // New Host global (like Termius +)
        const focusNewHost=()=>{ if(!this.saved.groups.length){this.saved.groups.push({id:this.uid(),name:'Ungrouped',open:true,servers:[]});this.persist();this.refreshGroupSelect();}
          document.getElementById('serverName').value='';document.getElementById('vpsIp').value='';document.getElementById('vpsPort').value='22';document.getElementById('vpsUser').value='';document.getElementById('vpsPass').value='';
          document.getElementById('serverName').focus(); this.showNotification('New Host','success');};
        document.getElementById('newHostGlobalBtn').addEventListener('click',focusNewHost);
        document.getElementById('fabAdd').addEventListener('click',focusNewHost);

        // Server management
        document.getElementById('saveServerBtn').addEventListener('click',()=>this.saveServer());
        document.getElementById('resetFormBtn').addEventListener('click',()=>this.resetForm());
        document.getElementById('connectBtn').addEventListener('click',()=>this.connectToVPS());
        document.getElementById('disconnectBtn').addEventListener('click',()=>this.disconnectFromVPS());

        // Quick actions
        document.getElementById('sudoSuBtn').addEventListener('click',()=>this.sendCommand('sudo su'));
        document.getElementById('clearBtn').addEventListener('click',()=>this.clearTerminal());
        document.getElementById('updateBtn').addEventListener('click',()=>this.sendCommand('apt update'));

        // Script selection
        document.querySelectorAll('.script-btn').forEach(btn=>{
          btn.addEventListener('click',()=>{
            document.querySelectorAll('.script-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');this.selectedScript=btn.dataset.script;
            document.getElementById('runScriptBtn').disabled=!this.isConnected;
            this.showNotification(`Selected: ${this.selectedScript.toUpperCase()}`,'success');
          });
        });

        document.getElementById('runScriptBtn').addEventListener('click',()=>{
          if(this.selectedScript){this.runScript(this.selectedScript);}else{this.showNotification('Please select a script first','error');}
        });
      }

      // ===== Terminal input =====
      handleTerminalInput(data){
        const code=data.charCodeAt(0);
        if(code===13){this.processCommand(this.currentLine);this.currentLine='';}
        else if(code===127){if(this.currentLine.length>0){this.currentLine=this.currentLine.slice(0,-1);this.term.write('\b \b');}}
        else if(code===27){
          if(data==='\u001b[A'){if(this.historyIndex<this.commandHistory.length-1){this.historyIndex++;this.currentLine=this.commandHistory[this.historyIndex];this.term.write('\r\x1b[K');this.writePrompt();this.term.write(this.currentLine);}}
          else if(data==='\u001b[B'){if(this.historyIndex>0){this.historyIndex--;this.currentLine=this.commandHistory[this.historyIndex];this.term.write('\r\x1b[K');this.writePrompt();this.term.write(this.currentLine);}else if(this.historyIndex===0){this.historyIndex=-1;this.currentLine='';this.term.write('\r\x1b[K');this.writePrompt();}}
        }else if(code>=32&&code<=126){this.currentLine+=data;this.term.write(data);}
      }

      processCommand(cmd){
        if(!cmd.trim()){this.writePrompt();return;}
        this.commandHistory.unshift(cmd);this.historyIndex=-1;this.term.write('\r\n');
        if(this.isConnected&&this.connectionId){this.sendSSHCommand(cmd);}
        else{this.writeToTerminal('Not connected to any VPS. Please connect first.\r\n');this.writePrompt();}
      }

      // ===== Connect / Run helpers =====
      async connectToVPS(data){
        const connectionData=data||{
          host:document.getElementById('vpsIp').value,
          port:parseInt(document.getElementById('vpsPort').value),
          username:document.getElementById('vpsUser').value,
          password:document.getElementById('vpsPass').value
        };
        if(!connectionData.host||!connectionData.username){this.showNotification('Please fill in IP and Username','error');return;}
        if(!this.socket||!this.socket.connected){this.showNotification('Backend server is not connected','error');return;}
        this.showNotification(`Connecting to ${connectionData.host}...`,'success');
        this.writeToTerminal(`\r\nüîå Connecting to ${connectionData.host}:${connectionData.port||22}...\r\n`);
        try{
          const resp=await fetch(`${this.backendUrl}/api/connect`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(connectionData)});
          const result=await resp.json();
          if(result.success){
            this.connectionId=result.connectionId;this.isConnected=true;this.currentServer=connectionData;this.socket.emit('join-connection',this.connectionId);
            this.updateConnectionStatus(true,connectionData.host);
            this.writeToTerminal(`‚úÖ Connected to ${connectionData.host} as ${connectionData.username}\r\nüéØ Now you can select and run any script!\r\n\r\n`);
            this.writePrompt(`${connectionData.username}@${connectionData.host}:~$ `);
            if(this.selectedScript){document.getElementById('runScriptBtn').disabled=false;}
            this.showNotification(`Successfully connected to ${connectionData.host}`,'success');
            const sidebar=document.getElementById('sidebar');if(sidebar.classList.contains('open')){sidebar.classList.remove('open');document.body.classList.remove('sidebar-open');}
          }else{
            this.writeToTerminal(`‚ùå Connection failed: ${result.message}\r\n`);this.writePrompt();this.showNotification(`Connection failed: ${result.message}`,'error');
          }
        }catch(e){this.writeToTerminal(`‚ùå Connection error: ${e.message}\r\n`);this.writePrompt();this.showNotification(`Connection error: ${e.message}`,'error');}
      }

      async quickConnect(server){
        // Fill form (nice for user) then connect
        this.loadServer(server); 
        await this.connectToVPS({host:server.ip,port:parseInt(server.port||'22'),username:server.user,password:server.pass});
      }

      async quickRun(server){
        if(!this.selectedScript){this.showNotification('Select a script first (SSHPLUS/AGNUDP/ZIVPN/V2RAY)','error');return;}
        // Connect first if needed, then run
        if(!this.isConnected || !this.currentServer || this.currentServer.host!==server.ip){
          await this.quickConnect(server);
        }
        await this.runScript(this.selectedScript);
      }

      async sendSSHCommand(command){
        if(!this.isConnected||!this.connectionId){this.showNotification('Please connect to a server first','error');return;}
        try{
          const resp=await fetch(`${this.backendUrl}/api/execute`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({connectionId:this.connectionId,command})});
          const result=await resp.json();if(!result.success){this.writeToTerminal(`Error: ${result.message}\r\n`);this.writePrompt();}
        }catch(e){this.writeToTerminal(`Command error: ${e.message}\r\n`);this.writePrompt();}
      }

      async runScript(scriptType){
        if(!this.isConnected||!this.connectionId){this.showNotification('Please connect to a server first','error');return;}
        const script=this.scripts[scriptType];if(!script){this.showNotification('Script not found','error');return;}
        this.showNotification(`Running ${scriptType.toUpperCase()} script...`,'success');
        try{this.writeToTerminal(`\r\nüöÄ Starting ${script.name} script...\r\nüìù Executing script automatically...\r\n\r\n`);await this.sendSSHCommand(script.command);}
        catch(e){this.writeToTerminal(`Script execution error: ${e.message}\r\n`);this.writePrompt();this.showNotification(`Script execution error: ${e.message}`,'error');}
      }

      async disconnectFromVPS(){
        if(!this.connectionId)return;
        try{
          await fetch(`${this.backendUrl}/api/disconnect`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({connectionId:this.connectionId})});
          this.isConnected=false;this.connectionId=null;this.currentServer=null;
          this.updateConnectionStatus(false,'Not connected');document.getElementById('runScriptBtn').disabled=true;
          this.writeToTerminal('\r\nüîå Disconnected from VPS\r\n\r\n');this.writePrompt();this.showNotification('Disconnected from server','success');
        }catch(e){console.error('Disconnection error:',e);}
      }

      sendCommand(cmd){if(!this.isConnected){this.showNotification('Please connect to a server first','error');return;}this.term.write(`\r\n${cmd}\r\n`);this.processCommand(cmd);}
      writeToTerminal(t){this.term.write(t);}writePrompt(p='vps-manager$ '){this.term.write(`\r\n${p}`);this.currentLine='';}
      clearTerminal(){this.term.clear();this.writeToTerminal('üöÄ VPS Script Runner - Terminal Cleared\r\n\r\n');this.writePrompt();}

      // ===== Save/Edit server =====
      saveServer(){
        const groupId=document.getElementById('groupSelect').value||null;
        const server={id:this.isEditing&&this.editingIds.serverId?this.editingIds.serverId:this.uid(),
          name:document.getElementById('serverName').value?.trim()||'Unnamed Server',
          ip:document.getElementById('vpsIp').value?.trim(),
          port:String(document.getElementById('vpsPort').value||'22'),
          user:document.getElementById('vpsUser').value?.trim(),
          pass:document.getElementById('vpsPass').value||'',
          date:new Date().toLocaleString()
        };
        if(!server.ip||!server.port||!server.user){this.showNotification('Please fill in at least IP, Port, and Username','error');return;}
        if(!this.saved.groups.length){this.saved.groups.push({id:this.uid(),name:'Ungrouped',open:true,servers:[]});}
        let target=this.saved.groups.find(g=>g.id===groupId)||this.saved.groups[0];

        if(this.isEditing&&this.editingIds.groupId&&this.editingIds.serverId){
          const old=this.saved.groups.find(g=>g.id===this.editingIds.groupId);if(old){const idx=old.servers.findIndex(s=>s.id===this.editingIds.serverId);if(idx>-1)old.servers.splice(idx,1);}
          const exIdx=target.servers.findIndex(s=>s.id===server.id);if(exIdx>-1)target.servers[exIdx]=server;else target.servers.push(server);
          this.isEditing=false;this.editingIds={groupId:null,serverId:null};this.showNotification('Server updated','success');
        }else{
          target.servers.unshift(server);this.showNotification('Server saved successfully!','success');
        }
        this.persist();this.renderGroups();this.resetForm();
      }

      loadServer(server,groupId){
        document.getElementById('serverName').value=server.name||'';
        document.getElementById('vpsIp').value=server.ip||'';
        document.getElementById('vpsPort').value=server.port||'22';
        document.getElementById('vpsUser').value=server.user||'';
        document.getElementById('vpsPass').value=server.pass||'';
        if(groupId){document.getElementById('groupSelect').value=groupId;}
        this.showNotification(`Loaded server: ${server.name}`,'success');
      }

      resetForm(){
        this.isEditing=false;this.editingIds={groupId:null,serverId:null};
        document.getElementById('serverName').value='';document.getElementById('vpsIp').value='';
        document.getElementById('vpsPort').value='22';document.getElementById('vpsUser').value='';document.getElementById('vpsPass').value='';
      }

      // ===== Status / toast =====
      updateConnectionStatus(connected,msg){
        const indicator=document.querySelector('#connectionStatusText').previousElementSibling;
        const statusText=document.getElementById('connectionStatusText');const sshText=document.getElementById('sshStatus');
        if(connected){indicator.classList.add('status-connected');statusText.textContent=`Connected to ${msg}`;sshText.textContent=`SSH: ${msg}`;document.getElementById('terminalStatus').textContent='Ready - Select script and click Run';}
        else{indicator.classList.remove('status-connected');statusText.textContent='Not connected';sshText.textContent='SSH: Not connected';document.getElementById('terminalStatus').textContent='Ready - Connect to VPS first';}
      }

      updateBackendStatus(msg,isConn){const el=document.getElementById('backendStatus');el.textContent=msg;if(isConn)el.classList.remove('offline');else el.classList.add('offline');}
      async checkBackendStatus(){
        try{const r=await fetch(`${this.backendUrl}/api/status`);const d=await r.json();if(d.status==='running'){this.updateBackendStatus('‚úÖ Backend: Connected',true);}else{this.updateBackendStatus('‚ùå Backend: Not responding',false);}}
        catch{this.updateBackendStatus('‚ùå Backend: Connection failed',false);}
      }

      showNotification(message,type='success'){const n=document.getElementById('notification');n.textContent=message;n.className=`notification ${type==='error'?'error':''}`;n.classList.add('show');setTimeout(()=>n.classList.remove('show'),2500);}
    }

    document.addEventListener('DOMContentLoaded',()=>{window.vpsManager=new VPSScriptRunner();});
  </script>
</body>
</html>
